# operation/app-chart/templates/model-service-monitor.yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: model-service-monitor
  namespace: monitoring
  labels:
    app: model-service
    release: monitoring  # Match Prometheus CRD label for discovery
spec:
  selector:
    matchLabels:
      app: model-service  # Match the Service labels in deployment.yml
  endpoints:
  - port: http  # Match the Service port name (to be added in deployment.yml)
    path: /metrics
    interval: 15s
---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: model-service-alerts
  namespace: monitoring
  labels:
    release: monitoring  # must match the label used by your Prometheus deployment
spec:
  groups:
  - name: model-service.rules
    rules:
      - alert: HighModelRequestLatency
        expr: histogram_quantile(0.95, rate(request_latency_seconds_bucket[5m])) > 1
        for: 2m
        labels:
          severity: warning
          namespace: monitoring # must have, 2 hr debugging
        annotations:
          summary: "High 95th percentile latency"
          description: "p95 request latency > 1s for over 2m."
      - alert: HighModelErrorRate
        expr: |
          rate(prediction_error_total[5m])
          / (rate(prediction_success_total[5m]) + rate(prediction_error_total[5m])) > 0.1
        for: 2m
        labels:
          severity: critical
          namespace: monitoring # must have, 2 hr debugging
        annotations:
          summary: "High prediction error rate"
          description: "Error rate > 10% over the last 5m."
---
apiVersion: monitoring.coreos.com/v1alpha1
kind: AlertmanagerConfig
metadata:
  name: app-alerts
  namespace: monitoring
  labels:
    alertmanagerConfig: "enabled"
spec:
  route:
    receiver: email-notifications
  receivers:
    - name: email-notifications
      emailConfigs:
        - smarthost: "mailpit-smtp.monitoring.svc.cluster.local:25"
          authUsername: ""
          authPassword:
            name: alertmanager-email-secret
            key: smtpPassword
          requireTLS: false
          from: "test@localhost"
          to: "ymchen2001@gmail.com"
